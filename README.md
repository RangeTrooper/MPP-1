# СПП, лабораторные работы №2, 3

SPA с серверной архитектурой REST и аутентификацией с JWT

# Использованные технологии:

  - node.js + Express.js на сервере;
  - plain CSS + HTML;
  - Bootstrap (v4.4.1), jQuery + AJAX;
  - JWT, bcrypt, httponly cookies для аутентификации;

# Функционал:
- просмотр списка гитар в виде таблицы (список хранится в БД MySQL);
- возможность фильтрации, сортировки списка в таблице, пагинация списка (с помощью библиотеки MDB);
- удаление/добавление информации о гитаре в список (БД MySQL).
- добавление изображения к элементу списка, отображение его в списке (в случае отсутствия используется картинка-заглушка).
- регистрация в веб-приложении (позволяет удалять существующие записи);

# Подробности реализации
1. Клиентская часть
    1. Сайт состоит из единственного HTML-файла index.html и файла со скриптами main.js. 
    2. SPA-стиль обеспечивается за счёт использования блочных элементов <div class="page">, в которые обёрнуты все страницы сайта. Пример:
         ```html
         <!---Страница добавления товара-->
         <div class="page" id=addingPage>
             <form name="input">
             ...
             </form>
         </div>
         <!--Страница входа в аккаунт-->
         <div class="page" id=loginPage>
         ...
         </div>
         ```
        Перемещение между страницами осуществляется за счёт изменения хеш-адреса. При его изменении вызывается функция
        ```js
        window.onhashchange = function () {
             render(window.location.hash);
        } 
        ```
        Функция render(hashkey) сперва скрывает все div'ы, а затем, исходя из значения хеша, изменяет свойство display у требуемого div
    3. Таблица реализована с помощью библиотек Material Design for Bootstrap. Обновление таблицы происходит после успешного выполнения запроса на сервер с целью удаления/добавления нового элемента в список при помощи метода append:
         ```js
         $("table tbody").append(row(guitar));
         ```
    4. Диалог выбора файла реализован с помощью стандартных средств JS:
         ```js
         <input id="file_input" name="image" type="file" onchange="uploadFile(this)">
        ```
        Отправка файла осуществляется за счёт выполнения метода uploadFile(input) и, в частности, функции fetch, файл передаётся как объект FormData
        ```js
        async function uploadFile(input) {
            let formData = new FormData();
            formData.append("file", input.files[0]);
            await fetch('/api/upload',{method: "POST", body: formData});
        }
        ```

2. Серверная часть
    1. Так как на сервере используется Express.js, обработка запросов с клиента выполняется функциями post(), get() и т.д. объекта express.
    2. Для взаимодействия с БД MySQL используется библиотека mysql2. Данные с сервера на клиент посылаются в формате JSON. Пример получения списка гитар из БД и отправки клиенту:
        ```js
            app.get("/api/guitars", function(req, res){
                 connection.query("SELECT * FROM warehouse;",function(err, results, fields) {
                     let guitars = JSON.stringify(results);
                    let content=JSON.parse(guitars);
                     res.send(content);
                  });
            });
        ```
    3. Аутентификация осуществляется по следующему принципу:
        1. В БД выполняется запрос для получения пользователя с заданным логином. 
        2. Модуль bcrypt сравнивает полученный от клиента пароль с хешем, хранящимся в БД. В случае совпадения выполняются последующие пункты, иначе отправляется код ошибки 401.
        3. Создаётся JWT на основе логина и секретного ключа с временем жизни в 1 час
        4. В заголовке ответа прописывается httponly cookie с  ключом token и соответствующим ему значением.
        5. Отправляется ответ.
    4. При попытке выполнить удаление объекта из списка на клиенте, на сервере первоначально будет проведена проверка пользовательского токена, полученного из cookie:
         ```js
         let token =req.cookies.token;
        if (token === undefined)
            res.status(401).send();
        else if (verifyToken(req.cookies.token)){
            //запрос в БД
        }
        ```
        Для верификации используется стандартная функция библиотеки jsonwebtoken.
    5. При нажатии на клиенте на кнопку "Выйти" на сервер отправляется запрос '/api/logout', в результате которого клиент получает ответ с cookie, в котором время жизни его сброшено. Таким образом, cookie уничтожается вместе с токеном. 
    
    # Видео с демонстрацией работы
    https://youtu.be/onaO3kIWKHs 

P.S. Прошу прощения за максимально кривой внешний вид страниц входа/регистрации, это остатки от не-SPA версии приложения, до которых не дошли руки.

P.P.S. Возможно, я где-то накосячил с ветками в git. Если Вам будет удобнее, можно связаться со мной через ВК:
https://vk.com/not_a_samovar
